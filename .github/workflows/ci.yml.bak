name: CI

on: [pull_request]

env:
  COMPOSER_MEMORY_LIMIT: -1
  SIMPLETEST_DB: sqlite://tmp/site.sqlite
  SIMPLETEST_BASE_URL: "http://127.0.0.1:8080"
  MYSQL_HOST: database
  MYSQL_HOSTNAME: database
  MYSQL_USER: root
  MYSQL_PASSWORD: root
  MYSQL_DATABASE: drupal
  MYSQL_PORT: 3306
  # Github actions sets root home to /github/home

jobs:
  test:
    runs-on: 'ubuntu-20.04'
    # https://docs.github.com/en/actions/using-jobs/running-jobs-in-a-container
    container:
      image: drupalci/php-8.1-apache:dev
      ports:
        - 80

    # https://docs.github.com/en/actions/using-containerized-services/about-service-containers
    # Thank you so much: https://firefart.at/post/using-mysql-service-with-github-actions/
    services:
      database:
        image: mysql:8
        options: --health-cmd="mysqladmin ping" --health-interval=5s --health-timeout=2s --health-retries=3
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_PASSWORD }}
          MYSQL_DATABASE: ${{ env.MYSQL_DATABASE }}

    strategy:
      fail-fast: false
    steps:

      - name: Checkout
        uses: actions/checkout@v2

      - name: Prepare MYSQL_ variables
        shell: bash
        run: |
          env | grep MYSQL_ > .env
          echo "DRUSH_OPTIONS_URI=thinkdrop.pr${GITHUB_REF_NAME/\/merge/}.github.local.computer" >> .env

      - name: Environment Variables
        run: env

      - uses: ./.github/actions/drainpipe/setup-ssh
        env:
          HOME: /root
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#      - uses: ./.github/actions/drainpipe/set-env
#
#      - name: Install and Start DDEV
#        uses: ./.github/actions/drainpipe/ddev
#        with:
#          git-name: Drainpipe Bot
#          git-email: no-reply@example.com
#          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
#          ssh-known-host: in.support.devshop.cloud

      - name: Composer Install
        run: composer install

      - name: Check live connection
        run: bin/drush @live status

      - name: Link GitHub Workspace folder to docroot
        run: |
          rm -rf /var/www/html
          ln -sf $GITHUB_WORKSPACE/web /var/www/html

      - name: Start Apache
        run: service apache2 start

      - name: Check local connection
        run: |
          bin/drush status
          bin/drush sql:query 'SHOW TABLES;'

      - name: Sync data
        run: bin/drush sql:sync @live @self

      - name: Run Updates
        run: bin/drush updb

      - name: Run Tests
        run: bin/drush behat

      - name: Archive artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: behat-test-output
          path: web/sites/default/files/test_artifacts

# Uncomment when we add some tests.
#      - name: Run Tests
#        run: bin/drush behat

  build:
    runs-on: 'ubuntu-20.04'
    strategy:
      fail-fast: false
      matrix:
        include:
          - php-versions: '8.1'
    steps:

      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-versions }}
          extensions: gd, pdo_sqlite

      - name: Validate composer.json
        run: composer --verbose validate

      - name: Install dependencies
        run: composer --verbose install
